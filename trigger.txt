
-- Crear la tabla de bitácora
CREATE TABLE BitacoraContrato (
    ID_BITACORA INT IDENTITY(1,1) PRIMARY KEY,
    ACCION VARCHAR(20),
    ID_CONTRATO INT,
    ID_CLIENTE INT,
    ID_INTERES INT,
    ID_EMPLEADO INT,
    FECHA_CONTRATO DATE,
    HORA_CONTRATO TIME,
    PRESUPUESTO DECIMAL(10,2),
    TIPO_ADQUISICION VARCHAR(255),
    DESCRIPCION_CONTRATO TEXT
);

-- Trigger para inserción en la bitácora
CREATE TRIGGER bitacora_insert_contrato
ON CONTRATO
INSTEAD OF INSERT
AS
BEGIN
    INSERT INTO BitacoraContrato (ACCION, ID_CONTRATO, ID_CLIENTE, ID_INTERES, ID_EMPLEADO, FECHA_CONTRATO, HORA_CONTRATO, PRESUPUESTO, TIPO_ADQUISICION, DESCRIPCION_CONTRATO)
    SELECT 'Inserción', ID_CONTRATO, ID_CLIENTE, ID_INTERES, ID_EMPLEADO, FECHA_CONTRATO, HORA_CONTRATO, PRESUPUESTO, TIPO_ADQUISICION, DESCRIPCION_CONTRATO
    FROM inserted;
END;


CREATE TRIGGER bitacora_insert_contrato
ON Contrato
INSTEAD OF INSERT
AS
BEGIN
    INSERT INTO BitacoraContrato (ACCION, ID_CONTRATO, ID_CLIENTE, ID_INTERES, ID_EMPLEADO, FECHA_CONTRATO, HORA_CONTRATO, PRESUPUESTO, TIPO_ADQUISICION, DESCRIPCION_CONTRATO)
    SELECT 'Inserción (antes)', ID_CONTRATO, ID_CLIENTE, ID_INTERES, ID_EMPLEADO, FECHA_CONTRATO, HORA_CONTRATO, PRESUPUESTO, TIPO_ADQUISICION, DESCRIPCION_CONTRATO
    FROM inserted;
    
    INSERT INTO Contrato (ID_CONTRATO, ID_CLIENTE, ID_INTERES, ID_EMPLEADO, FECHA_CONTRATO, HORA_CONTRATO, PRESUPUESTO, TIPO_ADQUISICION, DESCRIPCION_CONTRATO)
    SELECT ID_CONTRATO, ID_CLIENTE, ID_INTERES, ID_EMPLEADO, FECHA_CONTRATO, HORA_CONTRATO, PRESUPUESTO, TIPO_ADQUISICION, DESCRIPCION_CONTRATO
    FROM inserted;
END;

-- Trigger para inserción en la bitácora (después de la inserción)
CREATE TRIGGER bitacora_insert_contrato_after
ON Contrato
AFTER INSERT
AS
BEGIN
    INSERT INTO BitacoraContrato (ACCION, ID_CONTRATO, ID_CLIENTE, ID_INTERES, ID_EMPLEADO, FECHA_CONTRATO, HORA_CONTRATO, PRESUPUESTO, TIPO_ADQUISICION, DESCRIPCION_CONTRATO)
    SELECT 'Inserción (despues)', ID_CONTRATO, ID_CLIENTE, ID_INTERES, ID_EMPLEADO, FECHA_CONTRATO, HORA_CONTRATO, PRESUPUESTO, TIPO_ADQUISICION, DESCRIPCION_CONTRATO
    FROM inserted;
    
    INSERT INTO Contrato (ID_CONTRATO, ID_CLIENTE, ID_INTERES, ID_EMPLEADO, FECHA_CONTRATO, HORA_CONTRATO, PRESUPUESTO, TIPO_ADQUISICION, DESCRIPCION_CONTRATO)
    SELECT ID_CONTRATO, ID_CLIENTE, ID_INTERES, ID_EMPLEADO, FECHA_CONTRATO, HORA_CONTRATO, PRESUPUESTO, TIPO_ADQUISICION, DESCRIPCION_CONTRATO
    FROM inserted;
END;

--Eliminar un trigger si es que llega haber uno creado con el mismo nombre
DROP TRIGGER IF EXISTS bitacora_insert_contrato;

Select * from CONTRATO
Select * from BitacoraContrato

--eliminar las filas nuevas insertadas
delete from CONTRATO where ID_CONTRATO = 51;

--reiniciar el contador de la bitacora
DBCC CHECKIDENT('BitacoraContrato', RESEED, 0);